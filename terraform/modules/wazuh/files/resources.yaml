resources:
  - apiVersion: networking.gke.io/v1
    kind: ManagedCertificate
    metadata:
      name: ${dashboard_certificate_name}
      namespace: ${ns}
      labels:
        app: wazuh
    spec:
      domains:
        - ${dashboard_domain}
  - apiVersion: networking.gke.io/v1
    kind: ManagedCertificate
    metadata:
      name: ${manager_certificate_name}
      namespace: ${ns}
      labels:
        app: wazuh
    spec:
      domains:
        - ${manager_domain}
  - apiVersion: networking.gke.io/v1
    kind: ManagedCertificate
    metadata:
      name: ${cert_certificate_name}
      namespace: ${ns}
      labels:
        app: wazuh
    spec:
      domains:
        - ${cert_domain}
          
  - apiVersion: cloud.google.com/v1
    kind: BackendConfig
    metadata:
      name: wazuh-dashboard-backend-config
      namespace: ${ns}
    spec:
      healthCheck:
        type: HTTPS
        port: 5601
        requestPath: /app/login
        timeoutSec: 5
        checkIntervalSec: 30
        healthyThreshold: 2
        unhealthyThreshold: 3
          
  - apiVersion: cloud.google.com/v1
    kind: BackendConfig
    metadata:
      name: cert-backend-config
      namespace: ${ns}
    spec:
      healthCheck:
        type: HTTP
        port: 8000
        requestPath: /health
        timeoutSec: 5
        checkIntervalSec: 30
        healthyThreshold: 2
        unhealthyThreshold: 3

  - apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: max-map-count-setter
      namespace: ${ns}
    spec:
      selector:
        matchLabels:
          name: max-map-count-setter
      template:
        metadata:
          labels:
            name: max-map-count-setter
        spec:
          # One tiny init container that sets the node kernel sysctl
          initContainers:
            - name: max-map-count-setter
              image: docker.io/bash:5.2.21
              resources:
                limits:
                  cpu: 100m
                  memory: 32Mi
              securityContext:
                privileged: true
                runAsUser: 0
              command: [ "/usr/local/bin/bash","-e","-c","echo 262144 > /proc/sys/vm/max_map_count" ]
          # Keep the pod around
          containers:
            - name: sleep
              image: docker.io/bash:5.2.21
              command: [ "sleep","infinity" ]
