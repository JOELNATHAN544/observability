name: Terraform CI

on:
  pull_request:
    paths:
      - '**/terraform/**'
      - '.github/workflows/terraform-ci.yaml'
  push:
    branches:
      - main
    paths:
      - '**/terraform/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform-fmt:
    name: Format Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - argocd-agent
          - argocd
          - cert-manager
          - ingress-controller
          - lgtm-stack

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.0"

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ matrix.component }}/terraform
        run: terraform fmt -check -recursive
        continue-on-error: false

  terraform-validate:
    name: Validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - argocd-agent
          - argocd
          - cert-manager
          - ingress-controller
          - lgtm-stack

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.0"

      - name: Terraform Init
        id: init
        working-directory: ${{ matrix.component }}/terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        working-directory: ${{ matrix.component }}/terraform
        run: terraform validate -no-color

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - argocd-agent
          - argocd
          - cert-manager
          - ingress-controller
          - lgtm-stack

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles(format('{0}/terraform/.tflint.hcl', matrix.component)) }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.52.0

      - name: Initialize TFLint
        working-directory: ${{ matrix.component }}/terraform
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Run TFLint
        working-directory: ${{ matrix.component }}/terraform
        run: tflint --recursive --format compact

  tfsec:
    name: Security Scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component:
          - argocd-agent
          - argocd
          - cert-manager
          - ingress-controller
          - lgtm-stack

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ matrix.component }}/terraform
          soft_fail: true

  summary:
    name: Report Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, tfsec]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const components = ['argocd-agent', 'argocd', 'cert-manager', 'ingress-controller', 'lgtm-stack'];
            const jobResults = {
              fmt: '${{ needs.terraform-fmt.result }}',
              validate: '${{ needs.terraform-validate.result }}',
              tflint: '${{ needs.tflint.result }}',
              tfsec: '${{ needs.tfsec.result }}'
            };
            
            const statusIcon = (result) => {
              if (result === 'success') return '✅';
              if (result === 'failure') return '❌';
              return '⚠️';
            };
            
            const output = `### Terraform CI Results
            
            | Check | Status |
            |-------|--------|
            | Format | ${statusIcon(jobResults.fmt)} \`${jobResults.fmt}\` |
            | Validate | ${statusIcon(jobResults.validate)} \`${jobResults.validate}\` |
            | TFLint | ${statusIcon(jobResults.tflint)} \`${jobResults.tflint}\` |
            | Security Scan | ${statusIcon(jobResults.tfsec)} \`${jobResults.tfsec}\` |
            
            **Components checked:** ${components.join(', ')}
            
            *Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
